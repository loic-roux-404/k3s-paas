---

- name: Recover NodePort infos
  kubernetes.core.k8s:
    api_version: v1
    kind: Service
    name: waypoint-ui
    namespace: "{{ kubeapps_namespace }}"
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    spec:
      ports:
      - name: http
        port: 80
        targetPort: http
        nodePort: 30080
      - name: https
        port: 443
        targetPort: https
        nodePort: 30443
      - name: grpc
        port: 9701
        targetPort: grpc
        nodePort: 39701
      - name: https-2
        port: 9702
        targetPort: https
        nodePort: 39702

  register: waypoint_service

- name: Set waypoint service port
  set_fact:
    waypoint_service_port: "{{ waypoint_service.resources[0].spec.ports[2].nodePort }}"

- set_fact:
    waypoint_arch_lookup:
      amd64: amd64
      x86_64: amd64
      arm64: arm64
      aarch64: arm64

- set_fact:
    waypoint_arch: "{{ waypoint_arch_lookup[ansible_architecture] }}"

- name: Unzip kubeapps binary
  ansible.builtin.unarchive:
    src: "https://releases.hashicorp.com/waypoint/{{ waypoint_version }}/waypoint_{{ waypoint_version }}_linux_{{ waypoint_arch }}.zip"
    dest: /usr/local/bin/
    remote_src: yes

- name: Waypoint login
  command: waypoint login -server-addr={{ kubeapps_hostname }}:{{ waypoint_service_port }} -from-kubernetes
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Waypoint oidc
  command: |
    waypoint auth-method set oidc \
      -client-id="{{ dex_client_id }}" \
      -client-secret="{{ dex_client_secret }}" \
      -issuer=https://{{ dex_hostname }} \
      -list-claim-mapping="groups=groups" \
      -access-selector="{{ dex_github_client_org }}:{{ dex_github_client_team }} in list.groups" \
      dex
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
